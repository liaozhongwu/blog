<!doctype html>
	<head>
		<meta charset="utf-8">
		<style type="text/css">
			html,body {
				width: 100%;
			}
			body {
				display: flex;
				align-items: center;
			}
			#canvas {
				margin: 0 auto;
			}
		</style>
	</head>
	<body>
		<canvas id="canvas" width="800" height="420">Sorry, Your Broswer don't support canvas.</canvas>
		<script type="text/javascript">
			(function () {
				var canvas = document.getElementById("canvas")
				var rect = canvas.getBoundingClientRect()
				var context = canvas.getContext('2d')

				var WIDTH = rect.width;
				var HEIGHT = rect.height;
				var WAY_TOP = 400;
				var FRAME = 20;
				var BAR_SPEED = 5;
				var BAR_COUNT = 4;
				var BAR_MAX_WIDTH = 25;
				var BAR_MAX_HEIGHT = 50;
				var BAR_RANDOM_STEP = 5;
				var PLAYER_TOP = 360;
				var PLAYER_LEFT = 200;
				var PLAYER_WIDTH = 20;
				var PLAYER_HEIGHT = 40;
				var PLAYER_RISE_SPEED = 20;
				var PLAYER_RISE_PLUS_SPEED = 2;
				var player = null;
				var bars = null;
				var bar_speed = 0;
				var runInterval = null;
				var state = 0; 
				var rate = 0;
				var time = 0;

				function renderWay () {
					context.beginPath();
					context.moveTo(0, WAY_TOP);
					context.lineTo(WIDTH, WAY_TOP);
					context.stroke();
					context.closePath();
				}

				function renderPlayer () {
					if (player.jumping) {
						player.top -= player.rise_speed
						player.rise_speed -= player.rise_plus_speed

						if (player.rise_speed < 0 && player.top >= PLAYER_TOP) {
							player.top = PLAYER_TOP
							player.jumping = false
							player.rise_speed = 0
							player.rise_plus_speed = 0
						}
					}
					context.beginPath();
					context.arc(player.left + 10, player.top + 10, 10, 0, Math.PI*2, true);

					context.moveTo(player.left + 10, player.top + 20);
					context.lineTo(player.left, player.top + 30);

					context.moveTo(player.left + 10, player.top + 20);
					context.lineTo(player.left + 10, player.top + 30);

					context.moveTo(player.left + 10, player.top + 20);
					context.lineTo(player.left + 20, player.top + 30);

					context.moveTo(player.left + 10, player.top + 30);
					context.lineTo(player.left, player.top + 40);

					context.moveTo(player.left + 10, player.top + 30);
					context.lineTo(player.left + 20, player.top + 40);
					context.stroke();
					context.closePath();
				}

				function renderBar() {
					bars.forEach(function(bar) {
						bar.left -= bar_speed;
						if (bar.left <= 0) {
							rate++
							var w = randomWidth()
							var h = randomHeight()
							bar.left = WIDTH
							bar.top = WAY_TOP - h
							bar.width = w
							bar.height = h
						}
						context.fillRect(bar.left, bar.top, bar.width, bar.height);
					})
				}

				function renderData () {
					var data = ""
					context.font = "20px serif";
					context.textAlign = "center";
					context.fillText("按P暂停，按空格继续", WIDTH / 2, 20)
					context.fillText("按R重新开始，按↑或W跳跃", WIDTH / 2, 40)
					context.fillText("当前分数：" + rate, WIDTH / 2, 60)
				}

				function randomWidth () {
					return Math.ceil(Math.random() * BAR_MAX_WIDTH / BAR_RANDOM_STEP) * BAR_RANDOM_STEP
				}

				function randomHeight () {
					return Math.ceil(Math.random() * BAR_MAX_HEIGHT / BAR_RANDOM_STEP) * BAR_RANDOM_STEP
				}

				function start () {
					player = {
						left: PLAYER_LEFT, 
						top: PLAYER_TOP, 
						width: PLAYER_WIDTH, 
						height: PLAYER_HEIGHT,
						jumping: false,
						rise_speed: 0,
						rise_plus_speed: 0
					};
					bars = [];
					var i = 0;
					while (i < BAR_COUNT) {
						var w = randomWidth()
						var h = randomHeight()
						bars.push({
							left: WIDTH + i * Math.floor(WIDTH / BAR_COUNT),
							top: WAY_TOP - h,
							width: w,
							height: h
						})
						i++;
					}
					bar_speed = BAR_SPEED;
					if (runInterval) {
						clearInterval(runInterval);
					}
					state = 1;
					runInterval = setInterval(render, FRAME);
					rate = 0;
					time = 0;
				}

				function jump () {
					if (!player.jumping) {
						player.jumping = true
						player.rise_speed = PLAYER_RISE_SPEED
						player.rise_plus_speed = PLAYER_RISE_PLUS_SPEED
					}
				}

				function clear() {
					context.clearRect(0, 0, WIDTH, HEIGHT);
				}

				function render () {
					clear()
					renderWay()
					renderBar()
					renderPlayer()
					renderData()
					time++

					if (time % 1000 === 0) {
						bar_speed++
					}

					for (var i = 0; i < bars.length; ++i) {
						if (crash(bars[i], player)) {
							return over();
						}
					}
				}

				function crash (rect1, rect2) {
					var minx = Math.max(rect1.left, rect2.left)
					var miny = Math.max(rect1.top, rect2.top)
					var maxx = Math.min(rect1.left+rect1.width, rect2.left+rect2.width)
					var maxy = Math.min(rect1.top+rect1.height, rect2.top+rect2.height)

					if (minx <= maxx && miny <= maxy) return true
					return false
				}

				function goon () {
					if (state === 2 && runInterval === null) {
						state = 1;
						runInterval = setInterval(render, FRAME);
					}
				}

				function pause () {
					if (state === 1 && runInterval) {
						state = 2;
						clearInterval(runInterval)
						runInterval = null
					}
				}

				function over () {
					if (runInterval) {
						state = 0;
						clearInterval(runInterval)
						runInterval = null
					}
				}

				document.addEventListener("keydown", function (e) {
					switch(e.keyCode) {
						case 82:
							start();
							break;
						case 80:
							pause()
							break;
						case 32:
							goon()
							break;
						case 38:
						case 87:
							jump();
							break;
					}
				})

				start();
			})()
		</script>
	</body>
</html>